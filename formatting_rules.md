# Правила форматирования для конвертации DOCX в Markdown

Анализ файлов samples/ выявил следующие паттерны и правила форматирования:

## 1. Структура файлов

### Frontmatter
Каждый файл должен начинаться с YAML frontmatter:
```yaml
---
title: Название главы/раздела
nextRead:         # (опционально)
  to: /путь/к/следующей/странице
  label: Название следующей страницы
---
```

### Основной заголовок
После frontmatter идет заголовок первого уровня, совпадающий с title:
```markdown
# Название главы
```

## 2. Заголовки

### Система нумерации
- H1 (`#`) - основной заголовок главы без номера
- H2 (`##`) - разделы с нумерацией типа "1.1", "2.1", "3.1"
- Формат: `## X.Y Название раздела`

### Сохранение исходной нумерации
Конвертер должен сохранять номера разделов в формате `X.Y` точно так, как в исходном документе, без пропусков и изменений.

### Примеры:
- `# Общие сведения`
- `## 1.1 Функциональное назначение` 
- `## 2.2 Состав плагинов`

## 3. Специальные блоки

### AppAnnotation блок
Используется для важной информации/аннотаций и визуально выделяется цветным фоном:
```markdown
::AppAnnotation
Текст аннотации может быть многострочным.
Описывает ключевые моменты раздела.
::
```

### Фоновое выделение
- Других видов фонового выделения в образцах не обнаружено;
- Примечания отображаются через `blockquote`, что также создаёт серый фон у текста.

## 4. Списки

### Маркированные списки
- Используется символ `-` (дефис) с пробелом
- Поддерживается многоуровневая вложенность
- Длинные элементы списка могут переноситься на несколько строк

Примеры:
```markdown
- обеспечение разработчиков каталогом документации;
- предоставление примеров фрагментов кода;
- ускорение процессов разработки.
```

### Объединение абзацев в списки
Последовательные абзацы, представляющие пункты перечисления, должны объединяться в маркированный список. Каждый абзац становится элементом списка с маркером `-`.

### Описательные списки компонентов
Названия компонентов заключаются в обратные кавычки, описание отделяется длинным тире. Каждый элемент заканчивается точкой с запятой, последний — точкой.
```markdown
- `Компонент` — описание компонента;
- `Другой компонент` — его описание.
```

## 5. Таблицы

### Стандартные таблицы
```markdown
| Заголовок 1 | Заголовок 2 | Заголовок 3 |
| ----------- | ----------- | ----------- |
| Данные      | Данные      | Данные      |
```

### Таблицы с выравниванием
```markdown
| Левый        | Центр  | Правый |
| :----------- | :----: | -----: |
| Левое        | Центр  | Правое |
```

### Переносы в ячейках
Для переносов строк в ячейках используется `<br>`:
```markdown
| Колонка |
| ------- |
| Строка 1<br>Строка 2<br>Строка 3 |
```

### Группировка строк и пустые ячейки
Для имитации объединённых ячеек используются отдельные строки с заполненной первой колонкой и пустыми остальными:
```markdown
| Браузер       | ОС           | Процессор |
| ------------- | ------------ | --------- |
| Google Chrome |              |           |
| Windows       | Windows 10   | Intel Pentium 4 |
| Linux         | Debian 10    | Intel Pentium 4 |
| Yandex Browser|              |           |
| Windows       | Windows 7    | Intel Pentium 4 |
```

### Подписи к таблицам
После каждой таблицы идет подпись в формате blockquote:
```markdown
> Таблица X – Описание таблицы
```

## 6. Примечания и цитаты

### Примечания
```markdown
> _Примечание_ – Текст примечания.
> Может быть многострочным.
```

### Обычные blockquote
```markdown
> Обычная цитата без специального форматирования
```

## 7. Inline форматирование

### Код
- Используются обратные кавычки для `кода`
- Технические термины и названия ПО: `Winter CMS`, `PostgreSQL`, `Docker`
- Стандарты и языки: `HTML5`, `CSS3`, `JavaScript`
- Многострочных блоков кода в образцах нет

### Акценты
- Курсив для терминов: _Примечание_
- Жирный для важных понятий (редко используется в образцах)

## 8. Ссылки

### Внутренние ссылки
```markdown
[разделе 7](/developer/administrator/winter-cms)
```

## 9. Абзацы и разделение

### Интервалы
- Пустая строка между абзацами
- Пустая строка после заголовков
- Пустая строка после списков
- Пустая строка после таблиц и их подписей

### Длинные абзацы
Абзацы могут быть довольно длинными и содержать несколько предложений без принудительных переносов.

## 10. Обработка изображений

Согласно requirements должны обрабатываться в формате:
```
::sign-image
src: <src>
sign: <sign>
::
```

## 11. Нумерация разделов

### Схема нумерации:
- Глава 1: разделы 1.1, 1.2, 1.3, 1.4
- Глава 2: разделы 2.1, 2.2, 2.3, ..., 2.9
- Глава 3: разделы 3.1, 3.2, 3.3

### В заголовках:
- Номер главы отсутствует в H1
- Номер раздела присутствует в H2
- Подразделы (если есть) будут H3 с тройной нумерацией (например, 3.1.1)

## 12. Консистентность стиля

### Технические термины
- Названия ПО всегда в обратных кавычках
- Аббревиатуры без кавычек: HTML5, CSS3, JavaScript
- Названия стандартов: ISO/IEC 9075:2011

### Пунктуация
- Списки заканчиваются точкой с запятой, последний элемент - точкой
- Описания в списках компонентов заканчиваются точкой с запятой
- В таблицах точки обычно не ставятся

### Языковые особенности
- Документы на русском языке
- Соблюдается официально-деловой стиль
- Используется техническая терминология

## 15. Блоки кода

### Указание языка программирования и имени файла
```markdown
```yaml docker-compose.yaml
version: "3"
services:
  web:
    image: nginx
```

### Терминальные команды с указанием Terminal
```markdown
```bash Terminal
sudo dnf install docker docker-compose
```

### Обычные блоки кода с языком
```markdown
```bash
sysctl -w net.core.somaxconn=1024
```

### Конфигурационные файлы
```markdown
```conf tuned.conf
[main]
include = throughput-performance
```

### Многострочные YAML блоки
```markdown
```yaml
apiVersion: v1
kind: Pod
metadata:
  name: cpu-affinity-example
```

## 16. Навигация в frontmatter

### Двунаправленная навигация
```yaml
---
title: Название главы

readPrev:
  to: /path/to/previous
  label: Предыдущий раздел

readNext:
  to: /path/to/next
  label: Следующий раздел
---
```

### Простая навигация вперед
```yaml
---
title: Название главы

nextRead:
  to: /path/to/next
  label: Следующий раздел
---
```

## 17. HTML таблицы для сложного форматирования

Когда стандартные Markdown таблицы не подходят из-за сложной структуры, используются HTML таблицы:

```html
<div class="joplin-table-wrapper">
    <table>
        <thead>
            <tr>
                <th>Параметр</th>
                <th>Команды</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>
                    <p>vm.swappiness</p>
                    <p>Управляет склонностью ядра использовать swap...</p>
                </td>
                <td>
                    <p>Проверка текущего значения:</p>
                    <p>sysctl vm.swappiness</p>
                </td>
            </tr>
        </tbody>
    </table>
</div>
```

## 18. Продвинутые паттерны ссылок

### Внутренние ссылки с якорями
```markdown
[разделе 7](/developer/administrator/winter-cms)
[3.1](/developer/administrator/technical-requirements#_31-требования-к-программному-обеспечению)
[см. раздел 6.2](/developer/administrator/monitoring#_62-хранение-постоянных-данных)
```

### Ссылки на разделы той же страницы
```markdown
([см. раздел 5.1.5](/developer/administrator/setup-os#_515-оптимизация-файловой-системы-и-дискового-ввода-вывода))
```

### Внешние ссылки с описанием
```markdown
[формирование описано в официальной документации](https://doc.traefik.io/traefik/middlewares/http/basicauth/)
```

### Прямые ссылки
```markdown
[https://git.rosa.ru/](https://git.rosa.ru/)
```

## 19. Расширенные inline элементы

### Комбинированное форматирование компонентов
```markdown
- `CMS-сервер` (`Winter CMS`) — основной элемент серверной части;
- плагины `Winter CMS` — модули, расширяющие функциональность CMS;
```

### Технические термины разных типов
- Названия ПО: `Winter CMS`, `PostgreSQL`, `Docker`
- Стандарты: `HTML5`, `CSS3`, `JavaScript`
- Протоколы и форматы: `HTTP(S)`, `TLS`, `JSON`, `YAML`
- Команды и утилиты: `sysctl`, `docker ps`, `systemctl`

### Курсив для служебных элементов
```markdown
> _Примечание_ – Текст примечания.
```

## 20. Специальные символы и форматирование

### Длинные тире
Используются длинные тире (—) в описаниях компонентов:
```markdown
- `CMS-сервер` (`Winter CMS`) — основной элемент серверной части;
```

### Кавычки
- Обычные кавычки для названий: "Портал разработчика"
- Двойные кавычки для строковых значений: "10240 65535"

### Специальные переносы в таблицах
В ячейках таблиц используются `<br>` для переносов:
```markdown
| Колонка |
| ------- |
| Windows 10;<br><br>Windows Server 2016 |
```

## 21. Нумерация и структура подразделов

### Многоуровневая нумерация разделов
Для подразделов используется нумерация типа:
- #### 5.1.1.1 sysctl
- #### 5.1.1.2 Tuned  
- #### 5.1.1.3 Дополнительные утилиты

### Нумерация глав и разделов в заголовках
- Глава 1: разделы 1.1, 1.2, 1.3, 1.4
- Глава 2: разделы 2.1, 2.2, 2.3, ..., 2.9
- И так далее

---

# ДОПОЛНИТЕЛЬНЫЕ ПРАВИЛА ДЛЯ ИСПРАВЛЕНИЯ ОШИБОК КОНВЕРТАЦИИ

## 13. Проблемы в chapters/ и их исправления

### 13.1 Неправильные уровни заголовков
**ПРОБЛЕМА**: В chapters используются H3 (###) вместо правильных H1 и H2
```markdown
### Общие сведения           ❌ НЕПРАВИЛЬНО
### Назначение              ❌ НЕПРАВИЛЬНО
```

**ПРАВИЛЬНО** (как в samples):
```markdown
# Общие сведения            ✅ H1 для основного заголовка главы
## 1.1 Назначение           ✅ H2 с нумерацией для разделов
```

### 13.2 Отсутствие нумерации разделов
**ПРОБЛЕМА**: В chapters отсутствует нумерация разделов из оригинального документа

Из dev.docx видна правильная структура:
```
# 1 Общие сведения
## 1.1 Назначение
## 1.2 Функции
# 2 Архитектура комплекса  
## 2.1 Основные компоненты
## 2.2 Состав плагинов
# 3 Технические и программные требования
## 3.1 Требования к программному обеспечению
## 3.2 Требования к аппаратному обеспечению
## 3.3 Требования к клиентской части
```

**ПРАВИЛО**: Конвертер должен восстанавливать номера глав и разделов согласно исходной структуре DOCX

### 13.3 Отсутствие AppAnnotation блоков
**ПРОБЛЕМА**: В chapters простой текст вместо AppAnnotation блоков

**НЕПРАВИЛЬНО**:
```markdown
Программный комплекс построен по модульной архитектуре...
```

**ПРАВИЛЬНО**:
```markdown
::AppAnnotation
Программный комплекс "Портал разработчика" построен по модульной архитектуре.
Архитектура реализована на базе Winter CMS и включает серверную часть...
::
```

### 13.4 Неправильное форматирование списков
**ПРОБЛЕМА**: В chapters простые абзацы вместо списков

**НЕПРАВИЛЬНО**:
```markdown
предоставление разработчикам доступа...

размещение готовых примеров...

обеспечение условий для ускоренной разработки...
```

**ПРАВИЛЬНО**:
```markdown
Комплекс реализует следующие основные функции:

- предоставление разработчикам доступа к актуальной документации;
- размещение готовых примеров фрагментов исходного кода;
- обеспечение условий для ускоренной разработки программного обеспечения.
```

### 13.5 Неправильное оформление технических компонентов
**ПРОБЛЕМА**: В chapters простые абзацы вместо списков компонентов

**НЕПРАВИЛЬНО**:
```markdown
CMS-сервер (Winter CMS) — основной элемент серверной части...

плагины Winter CMS — модули, расширяющие функциональность...
```

**ПРАВИЛЬНО**:
```markdown
- `CMS-сервер` (`Winter CMS`) — основной элемент серверной части;
- плагины `Winter CMS` — модули, расширяющие функциональность CMS;
```

### 13.6 Отсутствие правильных таблиц
**ПРОБЛЕМА**: В chapters неправильно структурированные таблицы

Должны быть:
- Правильные заголовки таблиц
- Подписи в формате blockquote
- Правильное выравнивание
- HTML `<br>` для переносов в ячейках

### 13.7 Дублирующиеся заголовки
**ПРОБЛЕМА**: В chapters/ встречаются дублирующиеся H1 заголовки

**НЕПРАВИЛЬНО**:
```markdown
# Общие сведения

# Общие сведения  ← ДУБЛИРОВАНИЕ

## 1.1 Назначение
```

**ПРАВИЛЬНО**:
```markdown
# Общие сведения

## 1.1 Назначение
```

### 13.8 Неправильные блоки кода
**ПРОБЛЕМА**: В chapters/ отсутствует указание типа блока кода и имени файла

**НЕПРАВИЛЬНО**:
```markdown
```
version: "3"
services:
  web:
    image: nginx
```

**ПРАВИЛЬНО**:
```markdown
```yaml docker-compose.yaml
version: "3"
services:
  web:
    image: nginx
```

### 13.9 Отсутствие навигации в frontmatter
**ПРОБЛЕМА**: В chapters/ используется простая навигация, а не двунаправленная

**НЕПРАВИЛЬНО**:
```yaml
---
title: Общие сведения
nextRead:
  to: /path/to/next
  label: Следующий раздел
---
```

**ПРАВИЛЬНО** (для средних глав):
```yaml
---
title: Тонкая настройка операционной системы

readPrev:
  to: /developer/administrator/install-and-launch
  label: Установка и запуск комплекса

readNext:
  to: /developer/administrator/monitoring
  label: Мониторинг и диагностика
---
```

### 13.10 Неправильное применение AppAnnotation блоков
**ПРОБЛЕМА**: В chapters/ AppAnnotation применяется к коротким фразам

**НЕПРАВИЛЬНО**:
```markdown
::AppAnnotation
Программный комплекс "Портал разработчика РОСА" предназначен для...
::

::AppAnnotation
Комплекс обеспечивает централизованный доступ ко всем ресурсам...
::
```

**ПРАВИЛЬНО** (один блок с полным описанием):
```markdown
::AppAnnotation
Программный комплекс "Портал разработчика" построен по модульной архитектуре.
Архитектура реализована на базе Winter CMS и включает серверную часть (бэкенд) для администрирования и управления контентом, а также клиентскую часть, доступную пользователям через веб-интерфейс браузера.
Клиентская часть предоставляет разработчикам доступ к функциональности портала, включая документацию, шаблоны, примеры кода и другие ресурсы, необходимые для разработки ПО для "РОСА Мобайл".
::
```

### 13.11 Повторяющийся контент
**ПРОБЛЕМА**: В chapters/ встречается повторение одного и того же текста

**НЕПРАВИЛЬНО**:
```markdown
Комплекс реализует следующие основные функции:

Комплекс реализует следующие основные функции:  ← ДУБЛИРОВАНИЕ
```

**ПРАВИЛЬНО**:
```markdown
Комплекс реализует следующие основные функции:

- предоставление разработчикам доступа к актуальной документации;
- размещение готовых примеров фрагментов исходного кода;
- обеспечение условий для ускоренной разработки.
```

## 14. Алгоритм исправления для конвертера

### 14.1 Восстановление структуры заголовков
1. H1 (`#`) - только для основного заголовка главы (без номера)
2. H2 (`##`) - для пронумерованных разделов (X.Y Название)
3. H3 (`###`) - только для подразделов (если есть)

### 14.2 Восстановление нумерации
Конвертер должен отслеживать структуру документа и присваивать номера:
- Глава 1: разделы 1.1, 1.2, 1.3, 1.4
- Глава 2: разделы 2.1, 2.2, 2.3, 2.4, 2.5, 2.6, 2.7, 2.8, 2.9
- Глава 3: разделы 3.1, 3.2, 3.3
- И так далее...

### 14.3 Детектирование AppAnnotation блоков
Первые абзацы разделов с описательным характером должны оборачиваться в AppAnnotation:
- Длинные описательные абзацы в начале раздела
- Обзорная информация о назначении/архитектуре
- Ключевые концепции и определения

### 14.4 Детектирование списков
Должны конвертироваться в маркированные списки:
- Последовательности задач/функций/компонентов
- Перечисления требований
- Списки технологий/инструментов

### 14.5 Форматирование frontmatter
Каждый файл должен начинаться с правильного YAML frontmatter:

**Для первой главы:**
```yaml
---
title: Точное название главы

nextRead:
  to: /путь/к/следующей/главе
  label: Название следующей главы
---
```

**Для средних глав:**
```yaml
---
title: Точное название главы

readPrev:
  to: /путь/к/предыдущей/главе
  label: Название предыдущей главы

readNext:
  to: /путь/к/следующей/главе
  label: Название следующей главы
---
```

**Для последней главы:**
```yaml
---
title: Точное название главы

readPrev:
  to: /путь/к/предыдущей/главе
  label: Название предыдущей главы
---
```

### 14.6 Обработка блоков кода
- Автоматически определять тип языка из контекста
- Добавлять имя файла если указано в тексте
- Использовать формат `bash Terminal` для команд в терминале
- Различать конфигурационные файлы от обычных команд

### 14.7 Детектирование дублирующегося контента  
- Удалять повторяющиеся заголовки H1
- Объединять дублирующиеся абзацы
- Проверять на повторения ключевых фраз

### 14.8 Правильное применение AppAnnotation
- AppAnnotation для длинных описательных блоков (2+ предложения)
- Объединять соседние короткие блоки в один большой
- Применять только к обзорной/архитектурной информации

### 14.9 Улучшенная обработка таблиц
- Автоматическое выравнивание (левое, центр, правое)
- Использование `<br>` для переносов в ячейках
- Генерация HTML таблиц для сложных случаев
- Добавление подписей в формате blockquote

### 14.10 Обработка навигационных ссылок
- Генерация внутренних ссылок с якорями
- Преобразование заголовков в якоря (транслитерация)
- Сохранение внешних ссылок как есть
