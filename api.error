(.venv) spec@spec-mvd:~/work/rosa/beautiful$ poetry run doc2md run dev-portal-admin.docx --out output_dir
INFO:doc2md.cli:Running the pipeline
Запуск конвертации для файла: dev-portal-admin.docx
Formatting chapters ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━   0% -:--:--
╭─────────────────────────────────────── Traceback (most recent call last) ───────────────────────────────────────╮
│ /home/spec/work/rosa/beautiful/.venv/lib/python3.12/site-packages/httpx/_transports/default.py:101 in           │
│ map_httpcore_exceptions                                                                                         │
│                                                                                                                 │
│    98 │   if len(HTTPCORE_EXC_MAP) == 0:                                                                        │
│    99 │   │   HTTPCORE_EXC_MAP = _load_httpcore_exceptions()                                                    │
│   100 │   try:                                                                                                  │
│ ❱ 101 │   │   yield                                                                                             │
│   102 │   except Exception as exc:                                                                              │
│   103 │   │   mapped_exc = None                                                                                 │
│   104                                                                                                           │
│                                                                                                                 │
│ ╭────────────────── locals ───────────────────╮                                                                 │
│ │ message = "Illegal header value b'Bearer '" │                                                                 │
│ ╰─────────────────────────────────────────────╯                                                                 │
│                                                                                                                 │
│ /home/spec/work/rosa/beautiful/.venv/lib/python3.12/site-packages/httpx/_transports/default.py:250 in           │
│ handle_request                                                                                                  │
│                                                                                                                 │
│   247 │   │   │   extensions=request.extensions,                                                                │
│   248 │   │   )                                                                                                 │
│   249 │   │   with map_httpcore_exceptions():                                                                   │
│ ❱ 250 │   │   │   resp = self._pool.handle_request(req)                                                         │
│   251 │   │                                                                                                     │
│   252 │   │   assert isinstance(resp.stream, typing.Iterable)                                                   │
│   253                                                                                                           │
│                                                                                                                 │
│ ╭────────────────────────────────────────────────── locals ───────────────────────────────────────────────────╮ │
│ │ httpcore = <module 'httpcore' from                                                                          │ │
│ │            '/home/spec/work/rosa/beautiful/.venv/lib/python3.12/site-packages/httpcore/__init__.py'>        │ │
│ │      req = <Request [b'POST']>                                                                              │ │
│ │  request = <Request('POST', 'https://openrouter.ai/api/v1/chat/completions')>                               │ │
│ │     self = <httpx.HTTPTransport object at 0x746d7ad1ce00>                                                   │ │
│ ╰─────────────────────────────────────────────────────────────────────────────────────────────────────────────╯ │
│                                                                                                                 │
│ /home/spec/work/rosa/beautiful/.venv/lib/python3.12/site-packages/httpcore/_sync/connection_pool.py:256 in      │
│ handle_request                                                                                                  │
│                                                                                                                 │
│   253 │   │   │   │   closing = self._assign_requests_to_connections()                                          │
│   254 │   │   │                                                                                                 │
│   255 │   │   │   self._close_connections(closing)                                                              │
│ ❱ 256 │   │   │   raise exc from None                                                                           │
│   257 │   │                                                                                                     │
│   258 │   │   # Return the response. Note that in this case we still have to manage                             │
│   259 │   │   # the point at which the response is closed.                                                      │
│                                                                                                                 │
│ ╭───────────────────────────────────────────── locals ──────────────────────────────────────────────╮           │
│ │      closing = []                                                                                 │           │
│ │   connection = <HTTPConnection ['https://openrouter.ai:443', HTTP/1.1, CLOSED, Request Count: 1]> │           │
│ │ pool_request = <httpcore._sync.connection_pool.PoolRequest object at 0x746d7b1a97c0>              │           │
│ │      request = <Request [b'POST']>                                                                │           │
│ │       scheme = 'https'                                                                            │           │
│ │         self = <ConnectionPool [Requests: 0 active, 0 queued | Connections: 0 active, 0 idle]>    │           │
│ │      timeout = 5.0                                                                                │           │
│ │     timeouts = {'connect': 5.0, 'read': 5.0, 'write': 5.0, 'pool': 5.0}                           │           │
│ ╰───────────────────────────────────────────────────────────────────────────────────────────────────╯           │
│                                                                                                                 │
│ /home/spec/work/rosa/beautiful/.venv/lib/python3.12/site-packages/httpcore/_sync/connection_pool.py:236 in      │
│ handle_request                                                                                                  │
│                                                                                                                 │
│   233 │   │   │   │                                                                                             │
│   234 │   │   │   │   try:                                                                                      │
│   235 │   │   │   │   │   # Send the request on the assigned connection.                                        │
│ ❱ 236 │   │   │   │   │   response = connection.handle_request(                                                 │
│   237 │   │   │   │   │   │   pool_request.request                                                              │
│   238 │   │   │   │   │   )                                                                                     │
│   239 │   │   │   │   except ConnectionNotAvailable:                                                            │
│                                                                                                                 │
│ ╭───────────────────────────────────────────── locals ──────────────────────────────────────────────╮           │
│ │      closing = []                                                                                 │           │
│ │   connection = <HTTPConnection ['https://openrouter.ai:443', HTTP/1.1, CLOSED, Request Count: 1]> │           │
│ │ pool_request = <httpcore._sync.connection_pool.PoolRequest object at 0x746d7b1a97c0>              │           │
│ │      request = <Request [b'POST']>                                                                │           │
│ │       scheme = 'https'                                                                            │           │
│ │         self = <ConnectionPool [Requests: 0 active, 0 queued | Connections: 0 active, 0 idle]>    │           │
│ │      timeout = 5.0                                                                                │           │
│ │     timeouts = {'connect': 5.0, 'read': 5.0, 'write': 5.0, 'pool': 5.0}                           │           │
│ ╰───────────────────────────────────────────────────────────────────────────────────────────────────╯           │
│                                                                                                                 │
│ /home/spec/work/rosa/beautiful/.venv/lib/python3.12/site-packages/httpcore/_sync/connection.py:103 in           │
│ handle_request                                                                                                  │
│                                                                                                                 │
│   100 │   │   │   self._connect_failed = True                                                                   │
│   101 │   │   │   raise exc                                                                                     │
│   102 │   │                                                                                                     │
│ ❱ 103 │   │   return self._connection.handle_request(request)                                                   │
│   104 │                                                                                                         │
│   105 │   def _connect(self, request: Request) -> NetworkStream:                                                │
│   106 │   │   timeouts = request.extensions.get("timeout", {})                                                  │
│                                                                                                                 │
│ ╭─────────────────────────────────────────────── locals ────────────────────────────────────────────────╮       │
│ │ http2_negotiated = False                                                                              │       │
│ │          request = <Request [b'POST']>                                                                │       │
│ │             self = <HTTPConnection ['https://openrouter.ai:443', HTTP/1.1, CLOSED, Request Count: 1]> │       │
│ │       ssl_object = <_ssl._SSLSocket object at 0x746d7b185840>                                         │       │
│ │           stream = <httpcore._backends.sync.SyncStream object at 0x746d7b30aed0>                      │       │
│ ╰───────────────────────────────────────────────────────────────────────────────────────────────────────╯       │
│                                                                                                                 │
│ /home/spec/work/rosa/beautiful/.venv/lib/python3.12/site-packages/httpcore/_sync/http11.py:136 in               │
│ handle_request                                                                                                  │
│                                                                                                                 │
│   133 │   │   │   with ShieldCancellation():                                                                    │
│   134 │   │   │   │   with Trace("response_closed", logger, request) as trace:                                  │
│   135 │   │   │   │   │   self._response_closed()                                                               │
│ ❱ 136 │   │   │   raise exc                                                                                     │
│   137 │                                                                                                         │
│   138 │   # Sending the request...                                                                              │
│   139                                                                                                           │
│                                                                                                                 │
│ ╭─────────────────────────────────────── locals ───────────────────────────────────────╮                        │
│ │  kwargs = {'request': <Request [b'POST']>}                                           │                        │
│ │ request = <Request [b'POST']>                                                        │                        │
│ │    self = <HTTP11Connection ['https://openrouter.ai:443', CLOSED, Request Count: 1]> │                        │
│ │   trace = <httpcore._trace.Trace object at 0x746d7b1a9040>                           │                        │
│ ╰──────────────────────────────────────────────────────────────────────────────────────╯                        │
│                                                                                                                 │
│ /home/spec/work/rosa/beautiful/.venv/lib/python3.12/site-packages/httpcore/_sync/http11.py:86 in handle_request │
│                                                                                                                 │
│    83 │   │   │   │   with Trace(                                                                               │
│    84 │   │   │   │   │   "send_request_headers", logger, request, kwargs                                       │
│    85 │   │   │   │   ) as trace:                                                                               │
│ ❱  86 │   │   │   │   │   self._send_request_headers(**kwargs)                                                  │
│    87 │   │   │   │   with Trace("send_request_body", logger, request, kwargs) as trace:                        │
│    88 │   │   │   │   │   self._send_request_body(**kwargs)                                                     │
│    89 │   │   │   except WriteError:                                                                            │
│                                                                                                                 │
│ ╭─────────────────────────────────────── locals ───────────────────────────────────────╮                        │
│ │  kwargs = {'request': <Request [b'POST']>}                                           │                        │
│ │ request = <Request [b'POST']>                                                        │                        │
│ │    self = <HTTP11Connection ['https://openrouter.ai:443', CLOSED, Request Count: 1]> │                        │
│ │   trace = <httpcore._trace.Trace object at 0x746d7b1a9040>                           │                        │
│ ╰──────────────────────────────────────────────────────────────────────────────────────╯                        │
│                                                                                                                 │
│ /home/spec/work/rosa/beautiful/.venv/lib/python3.12/site-packages/httpcore/_sync/http11.py:144 in               │
│ _send_request_headers                                                                                           │
│                                                                                                                 │
│   141 │   │   timeouts = request.extensions.get("timeout", {})                                                  │
│   142 │   │   timeout = timeouts.get("write", None)                                                             │
│   143 │   │                                                                                                     │
│ ❱ 144 │   │   with map_exceptions({h11.LocalProtocolError: LocalProtocolError}):                                │
│   145 │   │   │   event = h11.Request(                                                                          │
│   146 │   │   │   │   method=request.method,                                                                    │
│   147 │   │   │   │   target=request.url.target,                                                                │
│                                                                                                                 │
│ ╭─────────────────────────────────────── locals ────────────────────────────────────────╮                       │
│ │  request = <Request [b'POST']>                                                        │                       │
│ │     self = <HTTP11Connection ['https://openrouter.ai:443', CLOSED, Request Count: 1]> │                       │
│ │  timeout = 5.0                                                                        │                       │
│ │ timeouts = {'connect': 5.0, 'read': 5.0, 'write': 5.0, 'pool': 5.0}                   │                       │
│ ╰───────────────────────────────────────────────────────────────────────────────────────╯                       │
│                                                                                                                 │
│ /usr/lib/python3.12/contextlib.py:158 in __exit__                                                               │
│                                                                                                                 │
│   155 │   │   │   │   # tell if we get the same exception back                                                  │
│   156 │   │   │   │   value = typ()                                                                             │
│   157 │   │   │   try:                                                                                          │
│ ❱ 158 │   │   │   │   self.gen.throw(value)                                                                     │
│   159 │   │   │   except StopIteration as exc:                                                                  │
│   160 │   │   │   │   # Suppress StopIteration *unless* it's the same exception that                            │
│   161 │   │   │   │   # was passed to throw().  This prevents a StopIteration                                   │
│                                                                                                                 │
│ ╭────────────────────────────────── locals ──────────────────────────────────╮                                  │
│ │      self = <contextlib._GeneratorContextManager object at 0x746d7b1a9070> │                                  │
│ │ traceback = <traceback object at 0x746d7b3108c0>                           │                                  │
│ │     value = LocalProtocolError("Illegal header value b'Bearer '")          │                                  │
│ ╰────────────────────────────────────────────────────────────────────────────╯                                  │
│                                                                                                                 │
│ /home/spec/work/rosa/beautiful/.venv/lib/python3.12/site-packages/httpcore/_exceptions.py:14 in map_exceptions  │
│                                                                                                                 │
│   11 │   except Exception as exc:  # noqa: PIE786                                                               │
│   12 │   │   for from_exc, to_exc in map.items():                                                               │
│   13 │   │   │   if isinstance(exc, from_exc):                                                                  │
│ ❱ 14 │   │   │   │   raise to_exc(exc) from exc                                                                 │
│   15 │   │   raise  # pragma: nocover                                                                           │
│   16                                                                                                            │
│   17                                                                                                            │
│                                                                                                                 │
│ ╭─────────────────────────────────────── locals ────────────────────────────────────────╮                       │
│ │ map = {<class 'h11._util.LocalProtocolError'>: <class 'httpcore.LocalProtocolError'>} │                       │
│ ╰───────────────────────────────────────────────────────────────────────────────────────╯                       │
╰─────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
LocalProtocolError: Illegal header value b'Bearer '

The above exception was the direct cause of the following exception:

╭─────────────────────────────────────── Traceback (most recent call last) ───────────────────────────────────────╮
│ /home/spec/work/rosa/beautiful/src/doc2md/cli.py:89 in run                                                      │
│                                                                                                                 │
│    86 │   with Progress() as progress:                                                                          │
│    87 │   │   task = progress.add_task("Formatting chapters", total=len(chapters))                              │
│    88 │   │   for idx, chapter in enumerate(chapters, start=1):                                                 │
│ ❱  89 │   │   │   manifest, md = client.format_chapter(chapter)                                                 │
│    90 │   │   │   processed = postprocess.PostProcessor(md, idx, doc_slug).run()                                │
│    91 │   │   │   warnings = validators.run_all_validators(processed)                                           │
│    92 │   │   │   for w in warnings:                                                                            │
│                                                                                                                 │
│ ╭────────────────────────────────────────────────── locals ───────────────────────────────────────────────────╮ │
│ │     builder = <doc2md.prompt_builder.PromptBuilder object at 0x746d7c35d9d0>                                │ │
│ │     chapter = '<h1>1 Общие сведения</h1><h2>1.1 Назначение</h2>Программный комплекс "Портал раз'+966        │ │
│ │    chapters = [                                                                                             │ │
│ │               │   '<h1>1 Общие сведения</h1><h2>1.1 Назначение</h2>Программный комплекс "Портал раз'+966,   │ │
│ │               │   '<h1>2 Архитектура комплекса</h1>Программный комплекс "Портал разработчика" постр'+7311,  │ │
│ │               │   '<h1>3 Технические и программные требования</h1>Настоящий раздел содержит сведени'+6275,  │ │
│ │               │   '<h1>4 Установка и запуск комплекса</h1>Установка Комплекса осуществляется на сер'+12753, │ │
│ │               │   '<h1>5 Тонкая настройка операционной системы</h1>Настоящий раздел содержит рекоме'+20882, │ │
│ │               │   '<h1>6 Мониторинг и диагностика</h1>Для обеспечения бесперебойной работы Портала '+12124, │ │
│ │               │   '<h1>7 Управление контентом через Winter CMS</h1><h2>7.1 Назначение и возможности'+10303  │ │
│ │               ]                                                                                             │ │
│ │      client = <doc2md.llm_client.OpenRouterClient object at 0x746d7ad1cd70>                                 │ │
│ │    doc_slug = 'dev-portal-admin'                                                                            │ │
│ │   docx_path = 'dev-portal-admin.docx'                                                                       │ │
│ │     dry_run = False                                                                                         │ │
│ │        html = '<html><body><p><a id="_Hlk161748796"></a>АО "НТЦ ИТ РОСА"<a id="_Hlk153978459"><'+72631      │ │
│ │         idx = 1                                                                                             │ │
│ │  images_dir = PosixPath('output_dir/images')                                                                │ │
│ │       model = 'gpt-4o-mini'                                                                                 │ │
│ │  output_dir = 'output_dir'                                                                                  │ │
│ │ output_path = PosixPath('output_dir')                                                                       │ │
│ │    progress = <rich.progress.Progress object at 0x746d7af3a210>                                             │ │
│ │  rules_path = PosixPath('/home/spec/work/rosa/beautiful/formatting_rules.md')                               │ │
│ │ samples_dir = PosixPath('/home/spec/work/rosa/beautiful/samples')                                           │ │
│ │   style_map = PosixPath('/home/spec/work/rosa/beautiful/src/doc2md/mammoth_style_map.map')                  │ │
│ │        task = 0                                                                                             │ │
│ ╰─────────────────────────────────────────────────────────────────────────────────────────────────────────────╯ │
│                                                                                                                 │
│ /home/spec/work/rosa/beautiful/src/doc2md/llm_client.py:54 in format_chapter                                    │
│                                                                                                                 │
│   51 │   │                                                                                                      │
│   52 │   │   delay = 1                                                                                          │
│   53 │   │   for attempt in range(self.max_retries):                                                            │
│ ❱ 54 │   │   │   response = self._client.post(self.api_url, json=payload, headers=headers)                      │
│   55 │   │   │   if response.status_code in {429} or 500 <= response.status_code < 600:                         │
│   56 │   │   │   │   if attempt == self.max_retries - 1:                                                        │
│   57 │   │   │   │   │   response.raise_for_status()                                                            │
│                                                                                                                 │
│ ╭────────────────────────────────────────────────── locals ───────────────────────────────────────────────────╮ │
│ │      attempt = 0                                                                                            │ │
│ │ chapter_html = '<h1>1 Общие сведения</h1><h2>1.1 Назначение</h2>Программный комплекс "Портал раз'+966       │ │
│ │        delay = 1                                                                                            │ │
│ │      headers = {'Authorization': 'Bearer '}                                                                 │ │
│ │     messages = [                                                                                            │ │
│ │                │   {                                                                                        │ │
│ │                │   │   'role': 'system',                                                                    │ │
│ │                │   │   'content': 'You are an expert DOCX to Markdown converter. Follow all rules           │ │
│ │                precisely.\n\nIMPOR'+27613                                                                   │ │
│ │                │   },                                                                                       │ │
│ │                │   {                                                                                        │ │
│ │                │   │   'role': 'user',                                                                      │ │
│ │                │   │   'content': 'Convert this chapter HTML to Markdown. Return EXACTLY two blocks:\n1. A  │ │
│ │                JSON mani'+1187                                                                              │ │
│ │                │   }                                                                                        │ │
│ │                ]                                                                                            │ │
│ │      payload = {                                                                                            │ │
│ │                │   'model': 'gpt-4o-mini',                                                                  │ │
│ │                │   'messages': [                                                                            │ │
│ │                │   │   {                                                                                    │ │
│ │                │   │   │   'role': 'system',                                                                │ │
│ │                │   │   │   'content': 'You are an expert DOCX to Markdown converter. Follow all rules       │ │
│ │                precisely.\n\nIMPOR'+27613                                                                   │ │
│ │                │   │   },                                                                                   │ │
│ │                │   │   {                                                                                    │ │
│ │                │   │   │   'role': 'user',                                                                  │ │
│ │                │   │   │   'content': 'Convert this chapter HTML to Markdown. Return EXACTLY two            │ │
│ │                blocks:\n1. A JSON mani'+1187                                                                │ │
│ │                │   │   }                                                                                    │ │
│ │                │   ]                                                                                        │ │
│ │                }                                                                                            │ │
│ │         self = <doc2md.llm_client.OpenRouterClient object at 0x746d7ad1cd70>                                │ │
│ ╰─────────────────────────────────────────────────────────────────────────────────────────────────────────────╯ │
│                                                                                                                 │
│ /home/spec/work/rosa/beautiful/.venv/lib/python3.12/site-packages/httpx/_client.py:1144 in post                 │
│                                                                                                                 │
│   1141 │   │                                                                                                    │
│   1142 │   │   **Parameters**: See `httpx.request`.                                                             │
│   1143 │   │   """                                                                                              │
│ ❱ 1144 │   │   return self.request(                                                                             │
│   1145 │   │   │   "POST",                                                                                      │
│   1146 │   │   │   url,                                                                                         │
│   1147 │   │   │   content=content,                                                                             │
│                                                                                                                 │
│ ╭────────────────────────────────────────────────── locals ───────────────────────────────────────────────────╮ │
│ │             auth = <httpx._client.UseClientDefault object at 0x746d7c7fa150>                                │ │
│ │          content = None                                                                                     │ │
│ │          cookies = None                                                                                     │ │
│ │             data = None                                                                                     │ │
│ │       extensions = None                                                                                     │ │
│ │            files = None                                                                                     │ │
│ │ follow_redirects = <httpx._client.UseClientDefault object at 0x746d7c7fa150>                                │ │
│ │          headers = {'Authorization': 'Bearer '}                                                             │ │
│ │             json = {                                                                                        │ │
│ │                    │   'model': 'gpt-4o-mini',                                                              │ │
│ │                    │   'messages': [                                                                        │ │
│ │                    │   │   {                                                                                │ │
│ │                    │   │   │   'role': 'system',                                                            │ │
│ │                    │   │   │   'content': 'You are an expert DOCX to Markdown converter. Follow all rules   │ │
│ │                    precisely.\n\nIMPOR'+27613                                                               │ │
│ │                    │   │   },                                                                               │ │
│ │                    │   │   {                                                                                │ │
│ │                    │   │   │   'role': 'user',                                                              │ │
│ │                    │   │   │   'content': 'Convert this chapter HTML to Markdown. Return EXACTLY two        │ │
│ │                    blocks:\n1. A JSON mani'+1187                                                            │ │
│ │                    │   │   }                                                                                │ │
│ │                    │   ]                                                                                    │ │
│ │                    }                                                                                        │ │
│ │           params = None                                                                                     │ │
│ │             self = <httpx.Client object at 0x746d7ad1d460>                                                  │ │
│ │          timeout = <httpx._client.UseClientDefault object at 0x746d7c7fa150>                                │ │
│ │              url = 'https://openrouter.ai/api/v1/chat/completions'                                          │ │
│ ╰─────────────────────────────────────────────────────────────────────────────────────────────────────────────╯ │
│                                                                                                                 │
│ /home/spec/work/rosa/beautiful/.venv/lib/python3.12/site-packages/httpx/_client.py:825 in request               │
│                                                                                                                 │
│    822 │   │   │   timeout=timeout,                                                                             │
│    823 │   │   │   extensions=extensions,                                                                       │
│    824 │   │   )                                                                                                │
│ ❱  825 │   │   return self.send(request, auth=auth, follow_redirects=follow_redirects)                          │
│    826 │                                                                                                        │
│    827 │   @contextmanager                                                                                      │
│    828 │   def stream(                                                                                          │
│                                                                                                                 │
│ ╭────────────────────────────────────────────────── locals ───────────────────────────────────────────────────╮ │
│ │             auth = <httpx._client.UseClientDefault object at 0x746d7c7fa150>                                │ │
│ │          content = None                                                                                     │ │
│ │          cookies = None                                                                                     │ │
│ │             data = None                                                                                     │ │
│ │       extensions = None                                                                                     │ │
│ │            files = None                                                                                     │ │
│ │ follow_redirects = <httpx._client.UseClientDefault object at 0x746d7c7fa150>                                │ │
│ │          headers = {'Authorization': 'Bearer '}                                                             │ │
│ │             json = {                                                                                        │ │
│ │                    │   'model': 'gpt-4o-mini',                                                              │ │
│ │                    │   'messages': [                                                                        │ │
│ │                    │   │   {                                                                                │ │
│ │                    │   │   │   'role': 'system',                                                            │ │
│ │                    │   │   │   'content': 'You are an expert DOCX to Markdown converter. Follow all rules   │ │
│ │                    precisely.\n\nIMPOR'+27613                                                               │ │
│ │                    │   │   },                                                                               │ │
│ │                    │   │   {                                                                                │ │
│ │                    │   │   │   'role': 'user',                                                              │ │
│ │                    │   │   │   'content': 'Convert this chapter HTML to Markdown. Return EXACTLY two        │ │
│ │                    blocks:\n1. A JSON mani'+1187                                                            │ │
│ │                    │   │   }                                                                                │ │
│ │                    │   ]                                                                                    │ │
│ │                    }                                                                                        │ │
│ │           method = 'POST'                                                                                   │ │
│ │           params = None                                                                                     │ │
│ │          request = <Request('POST', 'https://openrouter.ai/api/v1/chat/completions')>                       │ │
│ │             self = <httpx.Client object at 0x746d7ad1d460>                                                  │ │
│ │          timeout = <httpx._client.UseClientDefault object at 0x746d7c7fa150>                                │ │
│ │              url = 'https://openrouter.ai/api/v1/chat/completions'                                          │ │
│ ╰─────────────────────────────────────────────────────────────────────────────────────────────────────────────╯ │
│                                                                                                                 │
│ /home/spec/work/rosa/beautiful/.venv/lib/python3.12/site-packages/httpx/_client.py:914 in send                  │
│                                                                                                                 │
│    911 │   │                                                                                                    │
│    912 │   │   auth = self._build_request_auth(request, auth)                                                   │
│    913 │   │                                                                                                    │
│ ❱  914 │   │   response = self._send_handling_auth(                                                             │
│    915 │   │   │   request,                                                                                     │
│    916 │   │   │   auth=auth,                                                                                   │
│    917 │   │   │   follow_redirects=follow_redirects,                                                           │
│                                                                                                                 │
│ ╭─────────────────────────────────────── locals ────────────────────────────────────────╮                       │
│ │             auth = <httpx.Auth object at 0x746d7c7515e0>                              │                       │
│ │ follow_redirects = False                                                              │                       │
│ │          request = <Request('POST', 'https://openrouter.ai/api/v1/chat/completions')> │                       │
│ │             self = <httpx.Client object at 0x746d7ad1d460>                            │                       │
│ │           stream = False                                                              │                       │
│ ╰───────────────────────────────────────────────────────────────────────────────────────╯                       │
│                                                                                                                 │
│ /home/spec/work/rosa/beautiful/.venv/lib/python3.12/site-packages/httpx/_client.py:942 in _send_handling_auth   │
│                                                                                                                 │
│    939 │   │   │   request = next(auth_flow)                                                                    │
│    940 │   │   │                                                                                                │
│    941 │   │   │   while True:                                                                                  │
│ ❱  942 │   │   │   │   response = self._send_handling_redirects(                                                │
│    943 │   │   │   │   │   request,                                                                             │
│    944 │   │   │   │   │   follow_redirects=follow_redirects,                                                   │
│    945 │   │   │   │   │   history=history,                                                                     │
│                                                                                                                 │
│ ╭─────────────────────────────────────── locals ────────────────────────────────────────╮                       │
│ │             auth = <httpx.Auth object at 0x746d7c7515e0>                              │                       │
│ │        auth_flow = <generator object Auth.sync_auth_flow at 0x746d7b14a880>           │                       │
│ │ follow_redirects = False                                                              │                       │
│ │          history = []                                                                 │                       │
│ │          request = <Request('POST', 'https://openrouter.ai/api/v1/chat/completions')> │                       │
│ │             self = <httpx.Client object at 0x746d7ad1d460>                            │                       │
│ ╰───────────────────────────────────────────────────────────────────────────────────────╯                       │
│                                                                                                                 │
│ /home/spec/work/rosa/beautiful/.venv/lib/python3.12/site-packages/httpx/_client.py:979 in                       │
│ _send_handling_redirects                                                                                        │
│                                                                                                                 │
│    976 │   │   │   for hook in self._event_hooks["request"]:                                                    │
│    977 │   │   │   │   hook(request)                                                                            │
│    978 │   │   │                                                                                                │
│ ❱  979 │   │   │   response = self._send_single_request(request)                                                │
│    980 │   │   │   try:                                                                                         │
│    981 │   │   │   │   for hook in self._event_hooks["response"]:                                               │
│    982 │   │   │   │   │   hook(response)                                                                       │
│                                                                                                                 │
│ ╭─────────────────────────────────────── locals ────────────────────────────────────────╮                       │
│ │ follow_redirects = False                                                              │                       │
│ │          history = []                                                                 │                       │
│ │          request = <Request('POST', 'https://openrouter.ai/api/v1/chat/completions')> │                       │
│ │             self = <httpx.Client object at 0x746d7ad1d460>                            │                       │
│ ╰───────────────────────────────────────────────────────────────────────────────────────╯                       │
│                                                                                                                 │
│ /home/spec/work/rosa/beautiful/.venv/lib/python3.12/site-packages/httpx/_client.py:1014 in _send_single_request │
│                                                                                                                 │
│   1011 │   │   │   )                                                                                            │
│   1012 │   │                                                                                                    │
│   1013 │   │   with request_context(request=request):                                                           │
│ ❱ 1014 │   │   │   response = transport.handle_request(request)                                                 │
│   1015 │   │                                                                                                    │
│   1016 │   │   assert isinstance(response.stream, SyncByteStream)                                               │
│   1017                                                                                                          │
│                                                                                                                 │
│ ╭──────────────────────────────────── locals ────────────────────────────────────╮                              │
│ │   request = <Request('POST', 'https://openrouter.ai/api/v1/chat/completions')> │                              │
│ │      self = <httpx.Client object at 0x746d7ad1d460>                            │                              │
│ │     start = 6953.63595755                                                      │                              │
│ │ transport = <httpx.HTTPTransport object at 0x746d7ad1ce00>                     │                              │
│ ╰────────────────────────────────────────────────────────────────────────────────╯                              │
│                                                                                                                 │
│ /home/spec/work/rosa/beautiful/.venv/lib/python3.12/site-packages/httpx/_transports/default.py:249 in           │
│ handle_request                                                                                                  │
│                                                                                                                 │
│   246 │   │   │   content=request.stream,                                                                       │
│   247 │   │   │   extensions=request.extensions,                                                                │
│   248 │   │   )                                                                                                 │
│ ❱ 249 │   │   with map_httpcore_exceptions():                                                                   │
│   250 │   │   │   resp = self._pool.handle_request(req)                                                         │
│   251 │   │                                                                                                     │
│   252 │   │   assert isinstance(resp.stream, typing.Iterable)                                                   │
│                                                                                                                 │
│ ╭────────────────────────────────────────────────── locals ───────────────────────────────────────────────────╮ │
│ │ httpcore = <module 'httpcore' from                                                                          │ │
│ │            '/home/spec/work/rosa/beautiful/.venv/lib/python3.12/site-packages/httpcore/__init__.py'>        │ │
│ │      req = <Request [b'POST']>                                                                              │ │
│ │  request = <Request('POST', 'https://openrouter.ai/api/v1/chat/completions')>                               │ │
│ │     self = <httpx.HTTPTransport object at 0x746d7ad1ce00>                                                   │ │
│ ╰─────────────────────────────────────────────────────────────────────────────────────────────────────────────╯ │
│                                                                                                                 │
│ /usr/lib/python3.12/contextlib.py:158 in __exit__                                                               │
│                                                                                                                 │
│   155 │   │   │   │   # tell if we get the same exception back                                                  │
│   156 │   │   │   │   value = typ()                                                                             │
│   157 │   │   │   try:                                                                                          │
│ ❱ 158 │   │   │   │   self.gen.throw(value)                                                                     │
│   159 │   │   │   except StopIteration as exc:                                                                  │
│   160 │   │   │   │   # Suppress StopIteration *unless* it's the same exception that                            │
│   161 │   │   │   │   # was passed to throw().  This prevents a StopIteration                                   │
│                                                                                                                 │
│ ╭─────────────────────────────────────── locals ────────────────────────────────────────╮                       │
│ │      self = <contextlib._GeneratorContextManager object at 0x746d7b1a9880>            │                       │
│ │ traceback = <traceback object at 0x746d7b142e80>                                      │                       │
│ │     value = LocalProtocolError(LocalProtocolError("Illegal header value b'Bearer '")) │                       │
│ ╰───────────────────────────────────────────────────────────────────────────────────────╯                       │
│                                                                                                                 │
│ /home/spec/work/rosa/beautiful/.venv/lib/python3.12/site-packages/httpx/_transports/default.py:118 in           │
│ map_httpcore_exceptions                                                                                         │
│                                                                                                                 │
│   115 │   │   │   raise                                                                                         │
│   116 │   │                                                                                                     │
│   117 │   │   message = str(exc)                                                                                │
│ ❱ 118 │   │   raise mapped_exc(message) from exc                                                                │
│   119                                                                                                           │
│   120                                                                                                           │
│   121 class ResponseStream(SyncByteStream):                                                                     │
│                                                                                                                 │
│ ╭────────────────── locals ───────────────────╮                                                                 │
│ │ message = "Illegal header value b'Bearer '" │                                                                 │
│ ╰─────────────────────────────────────────────╯                                                                 │
╰─────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
LocalProtocolError: Illegal header value b'Bearer '
(.venv) spec@spec-mvd:~/work/rosa/beautiful$ cat .env
cat: .env: No such file or directory
(.venv) spec@spec-mvd:~/work/rosa/beautiful$ 
(.venv) spec@spec-mvd:~/work/rosa/beautiful$ poetry run doc2md run dev-portal-admin.docx --out output_dir
INFO:doc2md.cli:Running the pipeline
Запуск конвертации для файла: dev-portal-admin.docx
Formatting chapters ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━   0% -:--:--INFO:httpx:HTTP Request: POST https://openrouter.ai/api/v1 "HTTP/1.1 200 OK"
Formatting chapters ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━   0% -:--:--
╭─────────────────────────────────────── Traceback (most recent call last) ───────────────────────────────────────╮
│ /home/spec/work/rosa/beautiful/src/doc2md/cli.py:89 in run                                                      │
│                                                                                                                 │
│    86 │   with Progress() as progress:                                                                          │
│    87 │   │   task = progress.add_task("Formatting chapters", total=len(chapters))                              │
│    88 │   │   for idx, chapter in enumerate(chapters, start=1):                                                 │
│ ❱  89 │   │   │   manifest, md = client.format_chapter(chapter)                                                 │
│    90 │   │   │   processed = postprocess.PostProcessor(md, idx, doc_slug).run()                                │
│    91 │   │   │   warnings = validators.run_all_validators(processed)                                           │
│    92 │   │   │   for w in warnings:                                                                            │
│                                                                                                                 │
│ ╭────────────────────────────────────────────────── locals ───────────────────────────────────────────────────╮ │
│ │     builder = <doc2md.prompt_builder.PromptBuilder object at 0x723bee2dc7d0>                                │ │
│ │     chapter = '<h1>1 Общие сведения</h1><h2>1.1 Назначение</h2>Программный комплекс "Портал раз'+966        │ │
│ │    chapters = [                                                                                             │ │
│ │               │   '<h1>1 Общие сведения</h1><h2>1.1 Назначение</h2>Программный комплекс "Портал раз'+966,   │ │
│ │               │   '<h1>2 Архитектура комплекса</h1>Программный комплекс "Портал разработчика" постр'+7311,  │ │
│ │               │   '<h1>3 Технические и программные требования</h1>Настоящий раздел содержит сведени'+6275,  │ │
│ │               │   '<h1>4 Установка и запуск комплекса</h1>Установка Комплекса осуществляется на сер'+12753, │ │
│ │               │   '<h1>5 Тонкая настройка операционной системы</h1>Настоящий раздел содержит рекоме'+20882, │ │
│ │               │   '<h1>6 Мониторинг и диагностика</h1>Для обеспечения бесперебойной работы Портала '+12124, │ │
│ │               │   '<h1>7 Управление контентом через Winter CMS</h1><h2>7.1 Назначение и возможности'+10303  │ │
│ │               ]                                                                                             │ │
│ │      client = <doc2md.llm_client.OpenRouterClient object at 0x723bee0eaab0>                                 │ │
│ │    doc_slug = 'dev-portal-admin'                                                                            │ │
│ │   docx_path = 'dev-portal-admin.docx'                                                                       │ │
│ │     dry_run = False                                                                                         │ │
│ │        html = '<html><body><p><a id="_Hlk161748796"></a>АО "НТЦ ИТ РОСА"<a id="_Hlk153978459"><'+72631      │ │
│ │         idx = 1                                                                                             │ │
│ │  images_dir = PosixPath('output_dir/images')                                                                │ │
│ │       model = 'qwen/qwen3-4b:free'                                                                          │ │
│ │  output_dir = 'output_dir'                                                                                  │ │
│ │ output_path = PosixPath('output_dir')                                                                       │ │
│ │    progress = <rich.progress.Progress object at 0x723bee0ca270>                                             │ │
│ │  rules_path = PosixPath('/home/spec/work/rosa/beautiful/formatting_rules.md')                               │ │
│ │ samples_dir = PosixPath('/home/spec/work/rosa/beautiful/samples')                                           │ │
│ │   style_map = PosixPath('/home/spec/work/rosa/beautiful/src/doc2md/mammoth_style_map.map')                  │ │
│ │        task = 0                                                                                             │ │
│ ╰─────────────────────────────────────────────────────────────────────────────────────────────────────────────╯ │
│                                                                                                                 │
│ /home/spec/work/rosa/beautiful/src/doc2md/llm_client.py:62 in format_chapter                                    │
│                                                                                                                 │
│   59 │   │   │   │   delay *= 2                                                                                 │
│   60 │   │   │   │   continue                                                                                   │
│   61 │   │   │   response.raise_for_status()                                                                    │
│ ❱ 62 │   │   │   content = response.json()["choices"][0]["message"]["content"]                                  │
│   63 │   │   │   json_match = re.search(r"```json\n(.*?)\n```", content, re.DOTALL)                             │
│   64 │   │   │   md_match = re.search(r"```markdown\n(.*?)\n```", content, re.DOTALL)                           │
│   65 │   │   │   if not json_match or not md_match:                                                             │
│                                                                                                                 │
│ ╭────────────────────────────────────────────────── locals ───────────────────────────────────────────────────╮ │
│ │      attempt = 0                                                                                            │ │
│ │ chapter_html = '<h1>1 Общие сведения</h1><h2>1.1 Назначение</h2>Программный комплекс "Портал раз'+966       │ │
│ │        delay = 1                                                                                            │ │
│ │      headers = {                                                                                            │ │
│ │                │   'Authorization': 'Bearer                                                                 │ │
│ │                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'                   │ │
│ │                }                                                                                            │ │
│ │     messages = [                                                                                            │ │
│ │                │   {                                                                                        │ │
│ │                │   │   'role': 'system',                                                                    │ │
│ │                │   │   'content': 'You are an expert DOCX to Markdown converter. Follow all rules           │ │
│ │                precisely.\n\nIMPOR'+22324                                                                   │ │
│ │                │   },                                                                                       │ │
│ │                │   {                                                                                        │ │
│ │                │   │   'role': 'user',                                                                      │ │
│ │                │   │   'content': 'Convert this chapter HTML to Markdown. Return EXACTLY two blocks:\n1. A  │ │
│ │                JSON mani'+1187                                                                              │ │
│ │                │   }                                                                                        │ │
│ │                ]                                                                                            │ │
│ │      payload = {                                                                                            │ │
│ │                │   'model': 'qwen/qwen3-4b:free',                                                           │ │
│ │                │   'messages': [                                                                            │ │
│ │                │   │   {                                                                                    │ │
│ │                │   │   │   'role': 'system',                                                                │ │
│ │                │   │   │   'content': 'You are an expert DOCX to Markdown converter. Follow all rules       │ │
│ │                precisely.\n\nIMPOR'+22324                                                                   │ │
│ │                │   │   },                                                                                   │ │
│ │                │   │   {                                                                                    │ │
│ │                │   │   │   'role': 'user',                                                                  │ │
│ │                │   │   │   'content': 'Convert this chapter HTML to Markdown. Return EXACTLY two            │ │
│ │                blocks:\n1. A JSON mani'+1187                                                                │ │
│ │                │   │   }                                                                                    │ │
│ │                │   ]                                                                                        │ │
│ │                }                                                                                            │ │
│ │     response = <Response [200 OK]>                                                                          │ │
│ │         self = <doc2md.llm_client.OpenRouterClient object at 0x723bee0eaab0>                                │ │
│ ╰─────────────────────────────────────────────────────────────────────────────────────────────────────────────╯ │
│                                                                                                                 │
│ /home/spec/work/rosa/beautiful/.venv/lib/python3.12/site-packages/httpx/_models.py:832 in json                  │
│                                                                                                                 │
│    829 │   │   raise HTTPStatusError(message, request=request, response=self)                                   │
│    830 │                                                                                                        │
│    831 │   def json(self, **kwargs: typing.Any) -> typing.Any:                                                  │
│ ❱  832 │   │   return jsonlib.loads(self.content, **kwargs)                                                     │
│    833 │                                                                                                        │
│    834 │   @property                                                                                            │
│    835 │   def cookies(self) -> Cookies:                                                                        │
│                                                                                                                 │
│ ╭─────────── locals ───────────╮                                                                                │
│ │ kwargs = {}                  │                                                                                │
│ │   self = <Response [200 OK]> │                                                                                │
│ ╰──────────────────────────────╯                                                                                │
│                                                                                                                 │
│ /usr/lib/python3.12/json/__init__.py:346 in loads                                                               │
│                                                                                                                 │
│   343 │   if (cls is None and object_hook is None and                                                           │
│   344 │   │   │   parse_int is None and parse_float is None and                                                 │
│   345 │   │   │   parse_constant is None and object_pairs_hook is None and not kw):                             │
│ ❱ 346 │   │   return _default_decoder.decode(s)                                                                 │
│   347 │   if cls is None:                                                                                       │
│   348 │   │   cls = JSONDecoder                                                                                 │
│   349 │   if object_hook is not None:                                                                           │
│                                                                                                                 │
│ ╭────────────────────────────────────────────────── locals ───────────────────────────────────────────────────╮ │
│ │               cls = None                                                                                    │ │
│ │                kw = {}                                                                                      │ │
│ │       object_hook = None                                                                                    │ │
│ │ object_pairs_hook = None                                                                                    │ │
│ │    parse_constant = None                                                                                    │ │
│ │       parse_float = None                                                                                    │ │
│ │         parse_int = None                                                                                    │ │
│ │                 s = '<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta                      │ │
│ │                     name="viewport'+77669                                                                   │ │
│ ╰─────────────────────────────────────────────────────────────────────────────────────────────────────────────╯ │
│                                                                                                                 │
│ /usr/lib/python3.12/json/decoder.py:337 in decode                                                               │
│                                                                                                                 │
│   334 │   │   containing a JSON document).                                                                      │
│   335 │   │                                                                                                     │
│   336 │   │   """                                                                                               │
│ ❱ 337 │   │   obj, end = self.raw_decode(s, idx=_w(s, 0).end())                                                 │
│   338 │   │   end = _w(s, end).end()                                                                            │
│   339 │   │   if end != len(s):                                                                                 │
│   340 │   │   │   raise JSONDecodeError("Extra data", s, end)                                                   │
│                                                                                                                 │
│ ╭──────────────────────────────────────────── locals ─────────────────────────────────────────────╮             │
│ │   _w = <built-in method match of re.Pattern object at 0x723bef6998a0>                           │             │
│ │    s = '<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta name="viewport'+77669 │             │
│ │ self = <json.decoder.JSONDecoder object at 0x723bef67f980>                                      │             │
│ ╰─────────────────────────────────────────────────────────────────────────────────────────────────╯             │
│                                                                                                                 │
│ /usr/lib/python3.12/json/decoder.py:355 in raw_decode                                                           │
│                                                                                                                 │
│   352 │   │   try:                                                                                              │
│   353 │   │   │   obj, end = self.scan_once(s, idx)                                                             │
│   354 │   │   except StopIteration as err:                                                                      │
│ ❱ 355 │   │   │   raise JSONDecodeError("Expecting value", s, err.value) from None                              │
│   356 │   │   return obj, end                                                                                   │
│   357                                                                                                           │
│                                                                                                                 │
│ ╭──────────────────────────────────────────── locals ─────────────────────────────────────────────╮             │
│ │  idx = 0                                                                                        │             │
│ │    s = '<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta name="viewport'+77669 │             │
│ │ self = <json.decoder.JSONDecoder object at 0x723bef67f980>                                      │             │
│ ╰─────────────────────────────────────────────────────────────────────────────────────────────────╯             │
╰─────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
JSONDecodeError: Expecting value: line 1 column 1 (char 0)
(.venv) spec@spec-mvd:~/work/rosa/beautiful$ 